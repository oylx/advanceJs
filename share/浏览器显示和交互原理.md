æµè§ˆå™¨æ˜¾ç¤ºå’Œäº¤äº’çš„åŸç†

# ä¸€ã€æµè§ˆå™¨ä»½é¢

æµè§ˆå™¨å¸‚åœºä»½é¢å æ¯”ï¼š Chrome å…¨çƒæ˜¯å äº†66.6% ï¼Œå›½å†…æ˜¯å äº†28.1% ä»ä»¥ä¸Šæµè§ˆå™¨ä»½é¢ï¼Œå¯ä»¥çœ‹å‡ºï¼Œchromeå ç»å¯¹æ¯”ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¸»é¢˜å›´ç»•â€œæµè§ˆå™¨ä¸–ç•Œçš„ç‹è€…â€chromeæµè§ˆå™¨ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZjU4YTVjNGIwYzE0NWI3MDI5ZWQ1NmE5ZDA5OTMzOTFfSVhBR3I3SjdyclVmYnVCQ25sbkg5NTJTT2owcWZCYTlfVG9rZW46Ym94azRWWE1sbFZMSkZiRFJsOWlRRzdRMTliXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=NDU1NDQ0N2ZjOTg4OTBmOGY5OTUxZDg4NGJkN2M3ODRfWVFvWU53VXFkb0NaYTBkVHdvYjk1am1EOFlENGVjRFpfVG9rZW46Ym94azRJeDIwdENCNUpWNVp2OEdSSTZ2ekhnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

- å›½å†…æµè§ˆå™¨å¸‚åœºä»½é¢ https://tongji.baidu.com/research/site

- å…¨çƒæµè§ˆå™¨å¸‚åœºä»½é¢ https://gs.statcounter.com/
  - [å…¨çƒæµè§ˆå™¨å¸‚åœºä»½é¢](https://link.segmentfault.com/?enc=adaBLMwFgpsuWZqWH9cPjg==.AlVo51ZAKXiOHcfV8VrF3imA34uLrSdidjGaGbBb2zE=)

- [w3counter](https://link.segmentfault.com/?enc=AMwEuZeumFzQtWLFdHgrlA==.Pjyud9oH5alNVlYeTccncyOq2Uue7WtwmDP0nZWyPzskAY7KYvmbuhun0qcElgiP)

# äºŒã€æµè§ˆå™¨æ¨¡å—æ¶æ„

## 2.1 æµè§ˆå™¨æ¨¡å—

æµè§ˆå™¨å¯ä»¥æ‹†åˆ†ä¸ºè®¸å¤šç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸»è¦æ˜¯8ä¸ªæ¨¡å—ï¼šç”¨æˆ·ç•Œé¢æ¨¡å—ï¼ˆUIï¼‰ã€æµè§ˆå™¨å¼•æ“æ¨¡å—ï¼ˆBrowserï¼‰ã€æ¸²æŸ“å¼•æ“æ¨¡å—ï¼ˆRendererï¼‰ã€ç½‘ç»œæ¨¡å—ï¼ˆNetworkï¼‰ã€JavaScript è§£é‡Šå™¨ã€XML è§£æå™¨ã€æ˜¾ç¤ºåç«¯ï¼ˆDisplay Backendï¼‰ã€æ•°æ®æŒä¹…æ€§æ¨¡å—ï¼ˆData persistenceï¼‰ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YWFmYmYwMzYwM2EzMzhlZDBhYWQ3ZDM2ZDY4NDZjZGRfdkJXcDhNMEJtWEZZbmZUVjNQeTN1N1F6MkhIYm16YzZfVG9rZW46Ym94azRQM0NIUmc3bVA0Mmk1cEV4cnJUd0tnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

## 2.2 æµè§ˆå™¨æ¶æ„

åŸºäºè¿™äº›æ¨¡å—ï¼Œæµè§ˆå™¨æœ‰ä¸¤ç§å¯ç”¨çš„æ¶æ„è®¾è®¡ï¼Œä¸€ç§æ˜¯å°‘è¿›ç¨‹ï¼Œä¸€ç§æ˜¯å¤šè¿›ç¨‹ã€‚Chromeé‡‡ç”¨çš„å°±æ˜¯å¤šè¿›ç¨‹æ¶æ„ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MGQwZDBkY2M4YjAwODk2NGVjNDZiZDIwYzZkOTc1MDlfSnZXWTlkVmdNNWIwcXp4NW5nbUFSYTVzOEVJdjNTYzZfVG9rZW46Ym94azROWGFXSGVJUGJjUjhMYlBvdFBPSjVjXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

- æµè§ˆå™¨è¿›ç¨‹ï¼šä¸»è¦è´Ÿè´£ç•Œé¢æ˜¾ç¤ºã€ç”¨æˆ·äº¤äº’ã€å­è¿›ç¨‹ç®¡ç†ï¼ŒåŒæ—¶æä¾›å­˜å‚¨ç­‰åŠŸèƒ½ã€‚
- GPU è¿›ç¨‹ï¼šè´Ÿè´£å¤„ç†æ•´ä¸ªåº”ç”¨ç¨‹åºçš„GPUä»»åŠ¡ã€‚
- æ’ä»¶è¿›ç¨‹ï¼šä¸»è¦æ˜¯è´Ÿè´£æ’ä»¶çš„è¿è¡Œã€‚
- ç½‘ç»œè¿›ç¨‹ï¼šä¸»è¦è´Ÿè´£é¡µé¢çš„ç½‘ç»œèµ„æºåŠ è½½ï¼Œä¹‹å‰æ˜¯ä½œä¸ºä¸€ä¸ªæ¨¡å—è¿è¡Œåœ¨æµè§ˆå™¨è¿›ç¨‹é‡Œé¢çš„ï¼Œåé¢ç‹¬ç«‹å‡ºæ¥ï¼Œæˆä¸ºä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ã€‚
- æ¸²æŸ“å™¨è¿›ç¨‹ï¼šè´Ÿè´£ä¸€ä¸ªTabå†…çš„æ˜¾ç¤ºç›¸å…³çš„å·¥ä½œï¼Œä¹Ÿç§°æ¸²æŸ“å¼•æ“ã€‚

 ä¸‹é¢æ˜¯ Chromeâ€œé¢å‘æœåŠ¡çš„æ¶æ„â€çš„è¿›ç¨‹æ¨¡å‹å›¾ï¼š

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZWIyYzlkODMwYjQ5MGVkZmEzMDhmMGMyYTJkOTkwNDJfYldrN0RsOHhmWkU0eWJTQnNVcTkxVkhRVXVxUUZuSWJfVG9rZW46Ym94azQ1a2M3Ujl4QmF0RHhVQlI2UjJtV09jXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

1. é—®é¢˜ä¸€ï¼š**æµè§ˆå™¨æ‰“å¼€2ä¸ªé¡µé¢ï¼Œè‡³å°‘ä¼šæœ‰å‡ ä¸ªè¿›ç¨‹ï¼Ÿ**

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MDI5OTM3ZGNhOWQ4MjA3OGI5MDYwNWI2YWZkNjBjN2JfU1Q0emx1TlJEYU9qUTFFZXF6VGY5SHZraThxN3p6akJfVG9rZW46Ym94azRQZzV5bTJRTEpudFNtSHpmSDNNbWdiXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

1. é—®é¢˜äºŒï¼š

   Chrome ä½¿ç”¨å¤šä¸ªæ¸²æŸ“è¿›ç¨‹ï¼Œæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

   1. æ›´é«˜çš„å®¹é”™æ€§
   2. å®‰å…¨æ€§å’Œæ²™ç›’æ€§ï¼ˆsanboxingï¼‰ï¼šç”±äºæ“ä½œç³»ç»Ÿæä¾›äº†é™åˆ¶è¿›ç¨‹æƒé™çš„æ–¹æ³•ï¼Œæµè§ˆå™¨å°±å¯ä»¥ç”¨æ²™ç®±ä¿æŠ¤æŸäº›ç‰¹å®šåŠŸèƒ½çš„è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼ŒChrome æµè§ˆå™¨å¯ä»¥é™åˆ¶å¤„ç†ç”¨æˆ·ç‰¹æƒ/ç”¨æˆ·èµ„æº/ç”¨æˆ·è¯·æ±‚ã€‚
   3. å•/å¤šè¿›ç¨‹å¼¹æ€§æ¶æ„ï¼šChrome å¹¶ä¸æ»¡è¶³äºé‡‡ç”¨ä¸€ç§æ¶æ„ï¼Œè€Œæ˜¯åœ¨ä¸åŒç¯å¢ƒä¸‹åˆ‡æ¢ä¸åŒçš„æ¶æ„ï¼Œç›®å‰æ˜¯æœ‰4ç§è¿›ç¨‹æ¨¡å¼ï¼š

- **Process-per-site-instance** (default) - åŒä¸€ä¸ª **site-instance** ä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹

- **Process-per-site -** åŒä¸€ä¸ª **site** ä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹

- **Process-per-tab -** æ¯ä¸ª tab ä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹

- **Single process -** æ‰€æœ‰ tab å…±ç”¨ä¸€ä¸ªè¿›ç¨‹ã€‚

ä¼˜åŠ¿ï¼šå¯ä»¥åœ¨èµ„æºå—é™çš„æœºå™¨ä¸Šå¼€å¯å•è¿›ç¨‹æ¨¡å¼ï¼Œä»¥å°½é‡èŠ‚çº¦å†…å­˜å¼€é”€ï¼Œå®é™…ä¸Šåœ¨æ‰‹æœºåº”ç”¨ä¸Šå°±æ˜¯è¿™ä¹ˆåšçš„ï¼›è€Œåœ¨èµ„æºä¸°å¯Œã€å†…æ ¸æ•°é‡å……è¶³çš„æœºå™¨ä¸Šé‡‡ç”¨ç‹¬ç«‹è¿›ç¨‹æ¨¡å¼ï¼Œè™½ç„¶æ¶ˆè€—äº†æ›´å¤šèµ„æºï¼Œä½†è·å¾—äº†æ›´å¥½çš„ç¨³å®šæ€§ã€‚

1. ç«™ç‚¹éš”ç¦»

1. æ€è€ƒé¢˜ä¸‰ï¼š**æµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹æœ‰å“ªäº›çº¿ç¨‹ï¼Ÿ**

æµè§ˆå™¨å†…éƒ¨ä¼šé€šè¿‡æµè§ˆå™¨è¿›ç¨‹å’Œæ¸²æŸ“å™¨è¿›ç¨‹ï¼Œè¿›è¡Œå¾ˆå¤šäº¤äº’é€»è¾‘ï¼Œæœ€ç»ˆæ‰å¾—ä»¥å°†é¡µé¢å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MjMzMmFjYmMwMDkyYzcxNDUxZWIzNTJhM2U1YTRlNjNfenRuNjdvUk9oU2tDem10WmF0TkRkNzRLNUdpaUY3bzNfVG9rZW46Ym94azR0WUdKZ3J0blVvVHR3VDNXUXVXbVdoXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

# ä¸‰ã€é¡µé¢æ¸²æŸ“

## 3.1 æµè§ˆå™¨å†…æ ¸

æ— æ³•å¤åˆ¶åŠ è½½ä¸­çš„å†…å®¹

## 3.2 æ¸²æŸ“è¿‡ç¨‹

æ¸²æŸ“å™¨è¿›ç¨‹è´Ÿè´£é€‰é¡¹å¡å†…éƒ¨å‘ç”Ÿçš„æ‰€æœ‰äº‹æƒ…ï¼Œå®ƒçš„æ ¸å¿ƒå·¥ä½œæ˜¯å°† HTMLã€CSS å’Œ JavaScript è½¬æ¢ä¸ºå¯äº¤äº’çš„é¡µé¢ã€‚æ•´ä½“ä¸Šï¼Œæ¸²æŸ“å™¨è¿›ç¨‹æ¸²æŸ“é¡µé¢çš„ä¸»è¦æµç¨‹åŸºæœ¬å¦‚ä¸‹ã€‚

1. æ„å»ºDOMæ ‘ï¼ˆDOMï¼‰
2. æ ·å¼è®¡ç®—ï¼ˆComputedï¼‰
3. å¸ƒå±€(Layout)
4. åˆ†å±‚
5. ç»˜åˆ¶(Paint)
6. åˆ†å— (Tile)
7. å…‰æ …åŒ– ï¼ˆrasterï¼‰
8. åˆæˆï¼ˆCompositeï¼‰

è¯¦ç»†æµç¨‹å¦‚ä¸‹å›¾ï¼š

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MTUxYThiNWM3N2ViMzVmYTBmMjJiYzZmNTM4NGFjODBfWUxpcmJSS3NIQzZuQ1JsaFp1bUxDMzJ4UVNEZmpSZjJfVG9rZW46Ym94azRldzU4S0F1cmduaEdkRkJWRWRtWjBnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

### 3.2.1 æ„å»ºDOMæ ‘

æ„å»ºDOMæ ‘åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

- è§£ç ï¼ˆencodingï¼‰

- é¢„è§£æï¼ˆpre-parsingï¼‰

- ç¬¦å·åŒ–ï¼ˆTokenizationï¼‰

- æ„å»ºæ ‘ï¼ˆtree constructionï¼‰

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YTQwM2NjOGVlYmZlYjJlNTRkN2YzMDM0NmI5MGY4ODlfa0xzekFuOU9MT0FSZlVJMmttbzRTTnl2SVpWUWcwaFVfVG9rZW46Ym94azQzblY5c2VVVHFyQnlzMXlUenVMT3hmXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

### 3.2.2 æ ·å¼è®¡ç®—

æ ·å¼è®¡ç®—åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

-  æ ¼å¼åŒ–æ ·å¼è¡¨

-  æ ‡å‡†åŒ–æ ·å¼è¡¨

-  è®¡ç®—æ¯ä¸ªDOMèŠ‚ç‚¹å…·ä½“æ ·å¼

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YmI1NjY0NzcyODQyNDZkNTdkY2IyMjcyNzhhYjc5YzBfclhweGc5RDdRdHJaOFp4ZnZWMzhVMHRpaVYxamVKczhfVG9rZW46Ym94azRhTDBPdUEwa1c5R0JvbkdGTjk0WXVjXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZjVlYjU0MDcwYjA1ZGE5ZmU2OTMzNmIzNTlmNWRiN2VfNmtjVmRxWG45bDdaUm9JTU5CcEkxN3ppckZlWVg2RFpfVG9rZW46Ym94azRLS2I5ZFgzRjc1aGZaR3JXUEtCSGdkXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)



### 3.2.3 å¸ƒå±€ï¼ˆDOM->Layout Treeï¼‰

ä¸Šè¿°è¿‡ç¨‹å·²ç»å®ŒæˆDOMæ ‘ï¼ˆDOMæ ‘ï¼‰æ„å»ºï¼Œä»¥åŠæ ·å¼è®¡ç®—ï¼ˆDOMæ ·å¼ï¼‰ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦é€šè¿‡æµè§ˆå™¨çš„å¸ƒå±€ç³»ç»Ÿç¡®å®šå…ƒç´ ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å¸ƒå±€ã€‚

**æ¦‚å¿µï¼š**

> å¸ƒå±€æ ‘ï¼ˆLayout Treeï¼‰

> æ¸²æŸ“å¯¹è±¡ï¼ˆLayout Objectï¼‰

> æ³¨ï¼šç”±äº Chrome å¯¹ Blank å¼•æ“æŸäº›å®ç°çš„ä¿®æ”¹ï¼ŒæŸäº›æˆ‘ä»¬ä¹‹å‰ç†ŸçŸ¥çš„ç±»åæœ‰äº†å˜åŒ–ï¼Œæ¯”å¦‚ RenderObject å˜æˆäº† LayoutObjectï¼ŒRenderLayer å˜æˆäº† PaintLayerã€‚æ„Ÿå…´è¶£çš„çœ‹ä»¥å‚é˜… [Slimming Paint](https://www.chromium.org/blink/slimming-paint)ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MGQ1N2Q3NjZlNzg3YmU2MjYwMmRmYzMwNWU4MjBmMWFfcnNmeUlzRTJpMWFtZWZpOVVieENYTUdKMlBRT0ZReEFfVG9rZW46Ym94azRTOHpTNXhDTGRWcjlJQ2JGckJsVjRnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=N2Y4MzdlODdiMTg4ZmIwMjhkNjIwOTMwZjgzOTBhOTZfOWhRZXY4S1BybDN5VzV3anl3eXc2bmI2SW5GOTA3OThfVG9rZW46Ym94azRzWkpmRkdneml3dk42T25UQkVXQnpmXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

**åˆ›å»ºå¸ƒå±€æ ‘**

1. åœ¨DOMæ ‘ä¸Šä¸å¯è§çš„å…ƒç´ ï¼Œheadå…ƒç´ ï¼Œmetaå…ƒç´ ç­‰ï¼Œä»¥åŠä½¿ç”¨display:noneå±æ€§çš„å…ƒç´ ï¼Œæœ€åéƒ½ä¸ä¼šå‡ºç°åœ¨å¸ƒå±€æ ‘ä¸Šï¼Œæ‰€ä»¥**æµè§ˆå™¨å¸ƒå±€ç³»ç»Ÿéœ€è¦é¢å¤–å»æ„å»ºä¸€æ£µåªåŒ…å«å¯è§å…ƒç´ å¸ƒå±€æ ‘ã€‚**
2. æˆ‘ä»¬ç›´æ¥ç»“åˆå›¾æ¥çœ‹çœ‹è¿™ä¸ªå¸ƒå±€æ ‘æ„å»ºè¿‡ç¨‹ï¼š

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YmNlZWZjMTdhOGMwYmUwZjI2MGM5ZTVlYWE3NzRiZWRfWmgxZTRDNGJHVGlpZGxvbGZzVWNlWlMwUWJGTTBvR2xfVG9rZW46Ym94azQxaThxdGZtejBZQ3RtVm9Oc0NoODVlXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

### 3.2.4 åˆ†å±‚ï¼ˆLayout Tree->Layer Treeï¼‰

åœ¨ Chrome æœ€æ—©å‘å¸ƒæ—¶ï¼Œé‡‡ç”¨äº†ä¸€ç§è¾ƒä¸ºç®€å•çš„å…‰æ …åŒ–æ–¹æ¡ˆï¼Œå³ä»…æ¸²æŸ“å¯æ˜¯åŒºåŸŸå†…çš„åƒç´ ç‚¹ï¼Œå½“æ»šåŠ¨åï¼Œå†è¡¥å……æ¸²æŸ“å½“å‰æ»šåŠ¨ä½ç½®çš„åƒç´ ç‚¹ã€‚è¿™æ ·åšä¼šå¯¼è‡´æ¸²æŸ“æ°¸è¿œæ»åäºæ»šåŠ¨ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=OGM0Y2Q5ZTYxYjI5ZjdlN2E2ZmZjM2U0NmE0NTNiYjVfWHJtN3JVMHlSY1hTalJpTTRNMFFXU3lpandMamprZkRfVG9rZW46Ym94azRUSzJUS2NPU2tMa3NCZlNxMFFkRUxnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

ç°åœ¨ä¸€èˆ¬é‡‡ç”¨è¾ƒä¸ºæˆç†Ÿçš„åˆæˆæŠ€æœ¯ï¼ˆcompositingï¼‰ï¼Œå³å°†æ¸²æŸ“å†…å®¹åˆ†å±‚ç»˜åˆ¶ä¸æ¸²æŸ“ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MjQxNWIzOGFlOTg4ZTc3NjZiZDQ3OGQ5MzgzMmQ0YjFfNGtNbng2bkI1SmVkdEVpUjZXQVhFbm5GanNQYUZvamdfVG9rZW46Ym94azRRa252RUxwWXVWQVY3SlppMmZrNG9nXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

ç°åœ¨æˆ‘ä»¬æœ‰äº†å¸ƒå±€æ ‘ï¼Œè€Œä¸”æ¯ä¸ªå…ƒç´ çš„å…·ä½“ä½ç½®ä¿¡æ¯éƒ½è®¡ç®—å‡ºæ¥äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æ˜¯ä¸æ˜¯å°±è¦å¼€å§‹ç€æ‰‹ç»˜åˆ¶é¡µé¢äº†ï¼Ÿç­”æ¡ˆä¾ç„¶æ˜¯å¦å®šçš„ã€‚

å› ä¸ºé¡µé¢ä¸­æœ‰å¾ˆå¤šå¤æ‚çš„æ•ˆæœï¼Œå¦‚ä¸€äº›å¤æ‚çš„ 3D æ•ˆæœç­‰ï¼Œæ¸²æŸ“å¼•æ“è¿˜éœ€è¦ä¸ºç‰¹å®šçš„èŠ‚ç‚¹ç”Ÿæˆä¸“ç”¨çš„å›¾å±‚ï¼Œå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„å›¾å±‚æ ‘ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YzNmYTg2OTA3OWE4MjBmMGVlMTM1YmE5OThkZTc5YzFfQnNTNUZ0OEJRWldBaWhBOUhwaU45Z0NFRDlqcTdrQldfVG9rZW46Ym94azRpMFQ1M04wVk41eHd1T0V1OG9sUWhaXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

#### 3.2.4.1 æ¸²æŸ“å±‚ Paint Layer

ä¸€èˆ¬æ¥è¯´ï¼Œæ‹¥æœ‰ç›¸åŒçš„åæ ‡ç©ºé—´çš„ LayoutObjectsï¼Œå±äºåŒä¸€ä¸ªæ¸²æŸ“å±‚ï¼ˆPaintLayerï¼‰ã€‚PaintLayer æœ€åˆæ˜¯ç”¨æ¥å®ç° [stacking contestï¼ˆå±‚å ä¸Šä¸‹æ–‡ï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/Guide/CSS/Understanding_z_index/The_stacking_context)ï¼Œä»¥æ­¤æ¥ä¿è¯é¡µé¢å…ƒç´ ä»¥æ­£ç¡®çš„é¡ºåºåˆæˆï¼ˆcompositeï¼‰ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®çš„å±•ç¤ºå…ƒç´ çš„é‡å ä»¥åŠåŠé€æ˜å…ƒç´ ç­‰ç­‰ã€‚æ ¹æ®åˆ›å»º PaintLayer çš„åŸå› ä¸åŒï¼Œå¯ä»¥å°†å…¶åˆ†ä¸ºå¸¸è§çš„ 3 ç±»ï¼š

1. NormalPaintLayer
   1. æ ¹å…ƒç´ ï¼ˆHTMLï¼‰
   2. **æœ‰æ˜ç¡®çš„å®šä½å±æ€§**ï¼ˆrelativeã€fixedã€stickyã€absoluteï¼‰
   3. **é€æ˜çš„**ï¼ˆopacity å°äº 1ï¼‰
   4. æœ‰ CSS æ»¤é•œï¼ˆfliterï¼‰
   5. æœ‰ CSS mask å±æ€§
   6. æœ‰ CSS mix-blend-mode å±æ€§ï¼ˆä¸ä¸º normalï¼‰
   7. **æœ‰ CSS transform å±æ€§**ï¼ˆä¸ä¸º noneï¼‰
   8. backface-visibility å±æ€§ä¸º hidden
   9. æœ‰ CSS reflection å±æ€§
   10. æœ‰ CSS column-count å±æ€§ï¼ˆä¸ä¸º autoï¼‰æˆ–è€… æœ‰ CSS column-width å±æ€§ï¼ˆä¸ä¸º autoï¼‰
   11. å½“å‰æœ‰å¯¹äº opacityã€transformã€fliterã€backdrop-filter åº”ç”¨åŠ¨ç”»
2. OverflowClipPaintLayer
   1. overflow ä¸ä¸º visible
3. NoPaintLayer
   1. ä¸éœ€è¦ paint çš„ PaintLayerï¼Œæ¯”å¦‚ä¸€ä¸ªæ²¡æœ‰è§†è§‰å±æ€§ï¼ˆèƒŒæ™¯ã€é¢œè‰²ã€é˜´å½±ç­‰ï¼‰çš„ç©º divã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MGY4Y2U4OGM2MWFiNTViMDk3ZjBmMGQwMDRlZjhhZjVfT29xNFpYaG9USXdxYUhDZTFhd1AxZFBvNHFCYk5tVXJfVG9rZW46Ym94azRUTmx6NlEwcEpDZkFmNEdiMDA0N0tjXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

#### 3.2.4.2 åˆæˆå±‚ CompositingLayer

æ»¡è¶³æŸäº›ç‰¹æ®Šæ¡ä»¶çš„æ¸²æŸ“å±‚ï¼Œä¼šè¢«æµè§ˆå™¨è‡ªåŠ¨æå‡ä¸ºåˆæˆå±‚ã€‚åˆæˆå±‚æ‹¥æœ‰å•ç‹¬çš„ GraphicsLayerï¼Œè€Œå…¶ä»–ä¸æ˜¯åˆæˆå±‚çš„æ¸²æŸ“å±‚ï¼Œåˆ™å’Œå…¶ç¬¬ä¸€ä¸ªæ‹¥æœ‰ GraphicsLayer çš„çˆ¶å±‚å…±ç”¨ä¸€ä¸ªã€‚é‚£ä¹ˆä¸€ä¸ªæ¸²æŸ“å±‚æ»¡è¶³å“ªäº›ç‰¹æ®Šæ¡ä»¶æ—¶ï¼Œæ‰èƒ½è¢«æå‡ä¸ºåˆæˆå±‚å‘¢ï¼Ÿä¸»è¦åˆ†ä¸º2ç§

> æ˜¾å¼åˆæˆ(ç¡¬ä»¶åŠ é€Ÿ)

- **3D transforms**ï¼š**translate3dã€translateZ** ç­‰

-  **videoã€canvasã€iframe** ç­‰å…ƒ

-  é€šè¿‡ Ğ¡SS åŠ¨ç”»å®ç°çš„ opacity åŠ¨ç”»è½¬æ¢

-  å…·æœ‰ **will-change** å±æ€§

> éšå¼åˆæˆ(ä¸€ä¸ªæˆ–å¤šä¸ªéåˆæˆå…ƒç´ åº”å‡ºç°åœ¨å †å é¡ºåºä¸Šçš„åˆæˆå…ƒç´ ä¹‹ä¸Šï¼Œè¢«æå‡åˆ°åˆæˆå±‚)

ä¸¾ä¸ªğŸŒ° è¯´æ˜ä¸€ä¸‹ï¼š

ä¸¤ä¸ª absolute å®šä½çš„ div åœ¨å±å¹•ä¸Šäº¤å äº†ï¼Œæ ¹æ® `z-index` çš„å…³ç³»ï¼Œå…¶ä¸­ä¸€ä¸ª div å°±ä¼šâ€ç›–åœ¨â€œäº†å¦å¤–ä¸€ä¸ªä¸Šè¾¹ã€‚ 

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=Mjg4OTA0MmI2MDNiOTRkY2NkNDUwMzA0ZmM4ZjlmMDhfT3lQeE85ejJYeFViSVN1cVVoWW1BaUZkOTFtU2ZiUU1fVG9rZW46Ym94azRiTmROOE1tSGxDaWo1SGN3N0xsVEtDXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœå¤„äºä¸‹æ–¹çš„ div è¢«åŠ ä¸Šäº† CSS å±æ€§ï¼š`transform: translateZ(0)`ï¼Œå°±ä¼šè¢«æµè§ˆå™¨æå‡ä¸ºåˆæˆå±‚ã€‚æå‡åçš„åˆæˆå±‚ä½äº Document ä¸Šæ–¹ï¼Œå‡å¦‚æ²¡æœ‰éšå¼åˆæˆï¼ŒåŸæœ¬åº”è¯¥å¤„äºä¸Šæ–¹çš„ div å°±ä¾ç„¶è¿˜æ˜¯è·Ÿ Document å…±ç”¨ä¸€ä¸ª GraphicsLayerï¼Œå±‚çº§åè€Œé™äº†ï¼Œå°±å‡ºç°äº†å…ƒç´ äº¤å å…³ç³»é”™ä¹±çš„é—®é¢˜ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MDZhY2E5OGI3YzYwOTg1N2Y3ZTQ3NTE3ZGVmY2RjOGZfOW5KeDZHZDI5Qlp3ek9menRFOGdLR05RcHlxTWllU05fVG9rZW46Ym94azQ1ZHN1S290VTVvWTY1T3pIS25IOVFlXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)



æ‰€ä»¥ä¸ºäº†çº æ­£é”™è¯¯çš„äº¤å é¡ºåºï¼Œæµè§ˆå™¨å¿…é¡»è®©åŸæœ¬åº”è¯¥â€ç›–åœ¨â€œå®ƒä¸Šè¾¹çš„æ¸²æŸ“å±‚ä¹ŸåŒæ—¶æå‡ä¸ºåˆæˆå±‚ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=NjU1YTUwMjk5YzVmNzhjZGI5OTQxMTE3ODQ4MWY0ZjFfVTlGY0FUcnY4NVdDTEhrMW5TU1hOUm5MM3dicE9zaFpfVG9rZW46Ym94azQybk41N2V6UVdTc3hPZFdmUHRIN1lZXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

æ­£å¸¸é¡µé¢ï¼š

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZDI5OThkYjliYzFkMjVkMWJiMTAyNmE4MGNmNTY3NGZfVjhxejRvcXBpNXZPeU45S1AzU1NvOG9HUHdqRUlKVUdfVG9rZW46Ym94azRBcVcwMDFXODlJejlsZUthRW9jb2NjXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

éšå¼åˆæˆï¼š

```
.son2 {

  top: 50px;

  left: 120px;

  z-index: 2;

  background-color: #ef5fa7;

  transform: translateZ(0);

}
```

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=NzA5ZWI5MDNhNTlhY2Y5ZTc1NzY5YTJjMDMwMzBiNzZfSERrZ3lIdnpCd0hNQ3ZydEg4R1JIQXROMUFneVlMTVRfVG9rZW46Ym94azR2RVlFdGNWNExnbDlveHpPQzgwNEdkXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)



> å±‚çˆ†ç‚¸

å±‚çˆ†ç‚¸æ˜¯æŒ‡éšå¼åˆæˆçš„åŸå› ï¼Œå½“åˆæˆå±‚ä¸€ä¸ª`z-index`æ¯”è¾ƒä½çš„èŠ‚ç‚¹è¢«æå‡ä¸ºå•ç‹¬å›¾å±‚åï¼Œåªå¥½æŠŠä»–ä¸Šæ–¹æ‰€æœ‰å…ƒç´ éƒ½æå‡åˆ°åˆæˆå±‚ï¼Œä¸Šåƒä¸ªå›¾å±‚ï¼Œä¼šå¢å¤§å†…å­˜çš„å‹åŠ›ï¼Œæœ‰æ—¶å€™ä¼šè®©é¡µé¢å´©æºƒã€‚

> å±‚è‡ªåŠ¨åˆå¹¶

æµè§ˆå™¨ä¹Ÿä¼šæ”¯æŒå±‚å‹ç¼©ï¼Œæ¯”å¦‚éšå¼æå‡åˆ°åˆæˆå±‚æ—¶ï¼Œå¤šä¸ªå…ƒç´ ä¼šè‡ªåŠ¨åˆå¹¶åœ¨ä¸€ä¸ªåˆæˆå±‚é‡Œã€‚

> æ€§èƒ½ä¼˜åŒ–ï¼ˆåé¢è¯´ï¼‰

#### 3.2.4.3 å›¾å½¢å±‚ Graphics Layer

GraphicsLayer å…¶å®æ˜¯ä¸€ä¸ªè´Ÿè´£ç”Ÿæˆæœ€ç»ˆå‡†å¤‡å‘ˆç°çš„å†…å®¹å›¾å½¢çš„å±‚æ¨¡å‹ï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªå›¾å½¢ä¸Šä¸‹æ–‡ï¼ˆGraphicsContextï¼‰ï¼ŒGraphicsContext ä¼šè´Ÿè´£è¾“å‡ºè¯¥å±‚çš„ä½å›¾ã€‚å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­çš„ä½å›¾å°†ä½œä¸ºçº¹ç†ä¸Šä¼ åˆ° GPUï¼Œæœ€åç”± GPU å°†å¤šä¸ªä½å›¾è¿›è¡Œåˆæˆï¼Œç„¶åç»˜åˆ¶åˆ°å±å¹•ä¸Šï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çš„é¡µé¢ä¹Ÿå°±å±•ç°åˆ°äº†å±å¹•ä¸Šã€‚

æ‰€ä»¥ GraphicsLayer æ˜¯ä¸€ä¸ªé‡è¦çš„æ¸²æŸ“è½½ä½“å’Œå·¥å…·ï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥å¤„ç†æ¸²æŸ“å±‚ï¼Œè€Œæ˜¯å¤„ç†åˆæˆå±‚ã€‚

### 3.2.5 ç»˜åˆ¶ Paint

æ‰“å¼€æ§åˆ¶å°ï¼ŒAå°±æ˜¯ document çš„ç»˜åˆ¶åˆ—è¡¨ï¼Œæ‹–åŠ¨å³ä¾§è¿›åº¦æ¡Bå¯ä»¥é‡ç°åˆ—è¡¨çš„ç»˜åˆ¶è¿‡ç¨‹ã€‚ä»Aä¸­å¯ä»¥çœ‹å‡ºï¼Œç»˜åˆ¶åˆ—è¡¨ä¸­çš„æŒ‡ä»¤å…¶å®éå¸¸ç®€å•ï¼Œå°±æ˜¯è®©å…¶æ‰§è¡Œä¸€ä¸ªç®€å•çš„ç»˜åˆ¶æ“ä½œï¼Œæ¯”å¦‚ç»˜åˆ¶çŸ©å½¢æˆ–è€…é»‘è‰²çš„çº¿ç­‰ã€‚è€Œç»˜åˆ¶ä¸€ä¸ªå…ƒç´ é€šå¸¸éœ€è¦å¥½å‡ æ¡ç»˜åˆ¶æŒ‡ä»¤ï¼Œå› ä¸ºæ¯ä¸ªå…ƒç´ çš„èƒŒæ™¯ã€å‰æ™¯ã€è¾¹æ¡†éƒ½éœ€è¦å•ç‹¬çš„æŒ‡ä»¤å»ç»˜åˆ¶ã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ODYzZGMzNDk3OTA1YzA2YWI5MDIxMzI1MmQzM2E5OGVfTTNQSEFUOGlBV3VOc0s5ejZxQ0QzRXFtS2lNcG5ZUDZfVG9rZW46Ym94azRuTWlHRkZVWmg2amlKWlJQcDhWajJlXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

### 3.2.6 åˆ†å—

æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹ç»˜åˆ¶æ“ä½œäº†ï¼Œå®é™…ä¸Šåœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ç»˜åˆ¶æ“ä½œæ˜¯ç”±ä¸“é—¨çš„çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªçº¿ç¨‹å«**åˆæˆçº¿ç¨‹**ã€‚

-  åŸºäºå›¾å±‚çš„åŸå› ï¼Œåˆæˆçº¿ç¨‹ä¼šå°†å›¾å±‚åˆ’åˆ†ä¸ºå›¾å—(tile)

-  è¿™äº›å—çš„å¤§å°ä¸€èˆ¬ä¸ä¼šç‰¹åˆ«å¤§ï¼Œé€šå¸¸æ˜¯ 256 * 256 æˆ–è€… 512 * 512 è¿™ä¸ªè§„æ ¼ã€‚

### 3.2.7 å…‰æ …åŒ–

**æ‰€è°“æ …æ ¼åŒ–ï¼Œæ˜¯æŒ‡å°†å›¾å—è½¬æ¢ä¸ºä½å›¾ã€‚**

æœ‰äº†å›¾å—ä¹‹åï¼Œ**åˆæˆçº¿ç¨‹ä¼šæŒ‰ç…§è§†å£é™„è¿‘çš„å›¾å—æ¥ä¼˜å…ˆç”Ÿæˆä½å›¾ï¼Œå®é™…ç”Ÿæˆä½å›¾çš„æ“ä½œæ˜¯ç”±æ …æ ¼åŒ–æ¥æ‰§è¡Œçš„ã€‚**

- åˆæˆçº¿ç¨‹ä¼šé€‰æ‹©è§†å£é™„è¿‘çš„**å›¾å—(tile)**ï¼ŒæŠŠå®ƒäº¤ç»™**æ …æ ¼åŒ–çº¿ç¨‹æ± **ç”Ÿæˆä½å›¾

- æ¸²æŸ“è¿›ç¨‹ä¸­ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª**æ …æ ¼åŒ–çº¿ç¨‹æ± **ï¼Œä¸“é—¨è´Ÿè´£æŠŠ**å›¾å—**è½¬æ¢ä¸º**ä½å›¾æ•°æ®ï¼Œ**å›¾å—æ˜¯æ …æ ¼åŒ–æ‰§è¡Œçš„æœ€å°å•ä½

- ç”Ÿæˆä½å›¾çš„è¿‡ç¨‹å®é™…ä¸Šéƒ½ä¼šä½¿ç”¨ GPU è¿›è¡ŒåŠ é€Ÿï¼Œå¹¶ä¿å­˜åœ¨ GPU çš„å†…å­˜ä¸­

- ç”Ÿæˆçš„ä½å›¾æœ€åå‘é€ç»™åˆæˆçº¿ç¨‹

è¿è¡Œæ–¹å¼å¦‚ä¸‹

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=Zjc0NDk2NjcyOTExMzE2YTg2NGM3NzUyNjAwZDMwYWVfRDc5bVBaQ1JxYUk0T3FIQUlHOU55T0ZyT2RFOWtuakpfVG9rZW46Ym94azR0SlhWbkVvejJVbVhKQTdvdkFMOWJiXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

### 3.2.8 åˆæˆå’Œæ˜¾ç¤º

æ …æ ¼åŒ–æ“ä½œå®Œæˆåï¼Œ**åˆæˆçº¿ç¨‹**ä¼šç”Ÿæˆä¸€ä¸ªç»˜åˆ¶å‘½ä»¤ï¼Œå³"DrawQuad"ï¼Œå¹¶å‘é€ç»™æµè§ˆå™¨è¿›ç¨‹ã€‚æµè§ˆå™¨è¿›ç¨‹ä¸­æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤ï¼ŒæŠŠé¡µé¢å†…å®¹ç»˜åˆ¶åˆ°å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆäº†é¡µé¢ï¼Œç„¶åæŠŠè¿™éƒ¨åˆ†å†…å­˜å‘é€ç»™æ˜¾å¡ã€‚

# å››ã€é¡µé¢è¿è½¬

å‰é¢æˆ‘ä»¬è®²åˆ°äº†æ¯ä¸ªæ¸²æŸ“è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸»çº¿ç¨‹éå¸¸ç¹å¿™ï¼Œæ—¢è¦å¤„ç† DOMï¼Œåˆè¦è®¡ç®—æ ·å¼ï¼Œè¿˜è¦å¤„ç†å¸ƒå±€ï¼ŒåŒæ—¶è¿˜éœ€è¦å¤„ç† JavaScript ä»»åŠ¡ä»¥åŠå„ç§è¾“å…¥äº‹ä»¶ã€‚è¦è®©è¿™ä¹ˆå¤šä¸åŒç±»å‹çš„ä»»åŠ¡åœ¨ä¸»çº¿ç¨‹ä¸­æœ‰æ¡ä¸ç´Šåœ°æ‰§è¡Œï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªç³»ç»Ÿæ¥ç»Ÿç­¹è°ƒåº¦è¿™äº›ä»»åŠ¡ï¼Œè¿™ä¸ªç»Ÿç­¹è°ƒåº¦ç³»ç»Ÿå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—å’Œäº‹ä»¶å¾ªç¯ç³»ç»Ÿã€‚

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MzM4NjI4NDcwM2MyOTlmMDU1MDlhN2FjOGQyMWY4ZWJfaVk2T3llaWptcEtDSGdGQmFYRko3eUNZT3BpektLT0NfVG9rZW46Ym94azRCTFpIbUlONVI0cXU5UWFhZDU5MWNjXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

## 4.1 äº‹ä»¶å¾ªç¯æµç¨‹

1. å®ä»»åŠ¡
2. å¾®ä»»åŠ¡
3. è¿›å…¥æ›´æ–°æ¸²æŸ“é˜¶æ®µï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ¸²æŸ“ï¼ˆå¤šä¸ª task å¾ˆå¯èƒ½åœ¨ä¸€æ¬¡æ¸²æŸ“ä¹‹é—´æ‰§è¡Œï¼‰
4. å¦‚æœä¸Šè¿°çš„åˆ¤æ–­å†³å®šæœ¬è½®**ä¸éœ€è¦æ¸²æŸ“**ï¼Œé‚£ä¹ˆä¸‹é¢**çš„5-9å‡ æ­¥ä¹Ÿä¸ä¼šç»§ç»­è¿è¡Œ**ï¼šæœ‰æ—¶å€™æµè§ˆå™¨å¸Œæœ›ä¸¤æ¬¡ã€Œå®šæ—¶å™¨ä»»åŠ¡ã€æ˜¯åˆå¹¶çš„ï¼Œä»–ä»¬ä¹‹é—´åªä¼šç©¿æ’ç€ `microTask`çš„æ‰§è¡Œï¼Œè€Œä¸ä¼šç©¿æ’å±å¹•æ¸²æŸ“ç›¸å…³çš„æµç¨‹
5. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œå¦‚æœçª—å£çš„å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰§è¡Œç›‘å¬çš„ `resize` æ–¹æ³•ã€‚
6. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œå¦‚æœé¡µé¢å‘ç”Ÿäº†æ»šåŠ¨ï¼Œæ‰§è¡Œ `scroll` æ–¹æ³•ã€‚
7. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œæ‰§è¡Œå¸§åŠ¨ç”»å›è°ƒï¼Œä¹Ÿå°±æ˜¯ `requestAnimationFrame` çš„å›è°ƒã€‚
8. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œ æ‰§è¡Œ IntersectionObserver çš„å›è°ƒã€‚
9. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œ**é‡æ–°æ¸²æŸ“**ç»˜åˆ¶ç”¨æˆ·ç•Œé¢
10. åˆ¤æ–­ `taské˜Ÿåˆ—`å’Œ`microTask`é˜Ÿåˆ—æ˜¯å¦éƒ½ä¸ºç©ºï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è¿›è¡Œ `Idle`ç©ºé—²å‘¨æœŸçš„ç®—æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¦æ‰§è¡Œ `**requestIdleCallback**`çš„å›è°ƒå‡½æ•°ã€‚

## 4.2 æ€è€ƒ

1.éªŒè¯ç¬¬4ç‚¹ä¸éœ€è¦æ¸²æŸ“ï¼šå®ä»»åŠ¡ä¹‹é—´ä¸€å®šä¼šä¼´éšç€æµè§ˆå™¨ç»˜åˆ¶ï¼Ÿ

```
// æœªæ•æ‰ç²‰è‰²


const fn0 = () => {

  setTimeout(() => {

    document.body.style.background = "pink"

    setTimeout(() => {

      document.body.style.background = "gold"

    })

  })

}
```

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=NWRmZTFlMzU5YmE1M2JkMzg5YTBiZTBmMzM0NGNkOWZfZnhqV0RYYWxmRWJwQUVwS3Z3VVVYZEdISDZMdm5TakhfVG9rZW46Ym94azRYdThHaXJDaXplaGd6WHR2NzFOMmRnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

```
// æŠ“æ•åˆ°ç²‰è‰²

const fn1 = () => {

  setTimeout(() => {

    document.body.style.background = "pink"

    setTimeout(() => {

      document.body.style.background = "gold"

    },17*2)

  },17*1)

}
```

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MTNiMmIzYzkxZTQzZWZjMTdkZGU5YjQ1YzExYTEzOTVfZlE0b0hNZFFRbnZvT0Q2cTJYaGtOaUoyQzllRHlXU01fVG9rZW46Ym94azRTaEdwSXo5Zkxyejc1MWhnRGw0Q2RlXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

```
// raf

let i = 8

const fn2 = () => {

  i--

  requestAnimationFrame(() => {

    document.body.style.background = "pink"

    requestAnimationFrame(() => {

      document.body.style.background = "gold"

      if (i > 0) {

        fn2()

      }

    })

  })

}
```

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YmI4YTE3MDZkZWZhMWYzY2YzY2Y0N2Y2MTZlMWE0NDdfbEl3VzNoSDg2aWFFNXN3TzgxR2tYdDVOaERZcFpGQVdfVG9rZW46Ym94azRYdnBOWUZQU1B3Z1FGbHVHeHd5Qm5iXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

```
const fn3 = () => {

setTimeout(() => {

    console.log("3")

    requestAnimationFrame(() => console.log("4"))

})

setTimeout(() => {

    console.log("5")

    requestAnimationFrame(() => console.log("6"))

}, 6)



queueMicrotask(() => console.log("1"))

queueMicrotask(() => console.log("2"))



}

// 1

// 2

// 3

// 5

// 4

// 6
```

å¯ä»¥çœ‹å‡ºè¿™ä¸ªç»“æœæ˜¯éå¸¸ä¸å¯æ§çš„ï¼Œå¦‚æœè¿™ä¸¤ä¸ª `Task` ä¹‹é—´æ­£å¥½é‡åˆ°äº†æµè§ˆå™¨è®¤å®šçš„æ¸²æŸ“æœºä¼šï¼Œé‚£ä¹ˆå®ƒä¼šé‡ç»˜ï¼Œå¦åˆ™å°±ä¸ä¼šã€‚ç”±äºè¿™ä¿©å®ä»»åŠ¡çš„é—´éš”å‘¨æœŸå¤ªçŸ­äº†ï¼Œæ‰€ä»¥å¾ˆå¤§æ¦‚ç‡æ˜¯ä¸ä¼šçš„ã€‚

å¦‚æœä½ æŠŠå»¶æ—¶è°ƒæ•´åˆ° `17ms*N` é‚£ä¹ˆé‡ç»˜çš„æ¦‚ç‡ä¼šå¤§å¾ˆå¤šï¼Œæ¯•ç«Ÿè¿™ä¸ªæ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ `60fps` çš„ä¸€ä¸ªæŒ‡æ ‡ã€‚ä½†æ˜¯ä¹Ÿä¼šå‡ºç°å¾ˆå¤šä¸ç»˜åˆ¶çš„æƒ…å†µï¼Œæ‰€ä»¥å¹¶ä¸ç¨³å®šã€‚ å¦‚æœä½ ä¾èµ–è¿™ä¸ª API æ¥åšåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±å¾ˆå¯èƒ½ä¼šé€ æˆã€Œæ‰å¸§ã€ï¼Œå¯ä»¥ç”¨ `requestAnimationFrame`è§£å†³è¿™ä¸ªé—®é¢˜

2.ç¬¬10ç‚¹ä¸­çš„requestIdleCallbackæ˜¯ä»€ä¹ˆï¼Ÿ

> `requestIdleCallback` æ˜¯æµè§ˆå™¨æä¾›ç»™æˆ‘ä»¬çš„ç©ºé—²è°ƒåº¦ç®—æ³•ï¼Œæ„å›¾æ˜¯è®©æˆ‘ä»¬æŠŠä¸€äº›è®¡ç®—é‡è¾ƒå¤§ä½†æ˜¯åˆæ²¡é‚£ä¹ˆç´§æ€¥çš„ä»»åŠ¡æ”¾åˆ°ç©ºé—²æ—¶é—´å»æ‰§è¡Œã€‚ä¸è¦å»å½±å“æµè§ˆå™¨ä¸­ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ¨ç”»ç»˜åˆ¶ã€ç”¨æˆ·è¾“å…¥ç­‰ç­‰



> æ¸²æŸ“æœ‰åº

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZjNiMjA4Nzk1NTEwNTkwN2NhYmZhMDgzMmY5MDQyMzZfVHZjaTVRb3JMUGEzRHlyZW9LdHNaa0ZBUlp5SVRmbzBfVG9rZW46Ym94azRJMTJaaUpITmJCSTdZZ0Y1M3QzRDlkXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

> æ¸²æŸ“é•¿æœŸç©ºé—²

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=NjNlOWZkNTgwMjdhMTNhYTcxZjVmZGJhODNlM2UyZWJfNmpYczZhVnlnTWlNemxNYlBLdkUyelhYOHI0dzZmZnhfVG9rZW46Ym94azRGU0JwUlVab0QxVDJNMHpCUFYybmZoXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=N2MwYWEzZGViYWMzYWM1M2FkZTYxZmZiMDViOGE3YTJfdE5mRXg0NmpPNnhRSmY2SzAyRWNsZVVJYVFpWUJ2TFJfVG9rZW46Ym94azRvV0tiMHE2MGU5RTVKWmJPa0dVTHJiXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

```
<div id="SomeElementYouWantToAnimate"></div>

let start = null

const element = document.getElementById("SomeElementYouWantToAnimate")

element.style.position = "absolute"



function step(timestamp) {

  if (!start) start = timestamp

  const progress = timestamp - start

  element.style.left = Math.min(progress / 10, 500) + "px"

  if (progress < 2000) {

    window.requestAnimationFrame(step)

  }

}





function step(timestamp) {

  if (!start) start = timestamp

  var progress = timestamp - start

  element.style.left = Math.min(progress / 10, 200) + "px"

  let i = 1000

  while (i > 0) {

    console.log("å¿™ï¼ši", i)

    i--

  }

  if (progress < 2000) {

    window.requestAnimationFrame(step)

  }

}

// åŠ¨ç”»

window.requestAnimationFrame(step)



// ç©ºé—²è°ƒåº¦

window.requestIdleCallback((deadline) => {

  console.log('å‰©ä½™æ—¶é—´:',deadline.timeRemaining())

})
```

3.ç»“è®ºï¼š

- äº‹ä»¶å¾ªç¯**ä¸ä¸€å®š**æ¯è½®éƒ½ä¼´éšç€é‡æ¸²æŸ“ï¼Œä½†æ˜¯å¦‚æœæœ‰å¾®ä»»åŠ¡ï¼Œä¸€å®šä¼šä¼´éšç€**å¾®ä»»åŠ¡æ‰§è¡Œ**
- å†³å®šæµè§ˆå™¨è§†å›¾æ˜¯å¦æ¸²æŸ“çš„å› ç´ å¾ˆå¤š
- `requestAnimationFrame`åœ¨é‡æ–°æ¸²æŸ“å±å¹•**ä¹‹å‰**æ‰§è¡Œï¼Œéå¸¸é€‚åˆç”¨æ¥åšåŠ¨ç”»ã€‚
- `requestIdleCallback`åœ¨æ¸²æŸ“å±å¹•**ä¹‹å**æ‰§è¡Œï¼Œå¹¶ä¸”æ˜¯å¦æœ‰ç©ºæ‰§è¡Œè¦çœ‹æµè§ˆå™¨çš„è°ƒåº¦ï¼Œå¦‚æœä½ ä¸€å®šè¦å®ƒåœ¨æŸä¸ªæ—¶é—´å†…æ‰§è¡Œï¼Œè¯·ä½¿ç”¨ `timeout`å‚æ•°ã€‚
- `resize`å’Œ`scroll`äº‹ä»¶å…¶å®è‡ªå¸¦èŠ‚æµï¼Œå®ƒåªåœ¨ Event Loop çš„æ¸²æŸ“é˜¶æ®µå»æ´¾å‘äº‹ä»¶åˆ°`EventTarget` ä¸Šã€‚

# äº”ã€æ€§èƒ½ä¼˜åŒ–

## 5.1 æ¦‚å¿µ

> é‡æ’ reflowï¼ˆå›æµï¼‰

- é¡µé¢ä¸€å¼€å§‹æ¸²æŸ“çš„æ—¶å€™

- æµè§ˆå™¨çš„çª—å£å°ºå¯¸å˜åŒ–/æµè§ˆå™¨æ»šåŠ¨

- æ·»åŠ æˆ–åˆ é™¤å¯è§çš„DOMå…ƒç´ 

- å…ƒç´ çš„ä½ç½®/å°ºå¯¸å‘ç”Ÿå˜åŒ–

- å…ƒç´ å­—ä½“å¤§å°å˜åŒ–

- æ¿€æ´»CSSä¼ªç±»ï¼ˆä¾‹å¦‚ï¼š:hoverï¼‰

> é‡ç»˜repaint

- å½“é¡µé¢ä¸­å…ƒç´ æ ·å¼çš„æ”¹å˜å¹¶ä¸å½±å“å®ƒåœ¨æ–‡æ¡£æµä¸­çš„ä½ç½®æ—¶ï¼ˆä¾‹å¦‚ï¼š`color`ã€`background-color`ã€`visibility`ç­‰ï¼‰

## **5.2å¦‚ä½•ä¼˜åŒ–ï¼Ÿ**

1.ä¸è¦ä¸€æ¡æ¡åœ°æ”¹å˜æ ·å¼ï¼Œè€Œè¦é€šè¿‡æ”¹å˜classï¼Œæˆ–è€…jsçš„cssTextå±æ€§ï¼Œä¸€æ¬¡æ€§åœ°æ”¹å˜æ ·å¼ã€‚

```
.newClassName {left:10px;top:10px}var el = document.getElementById(â€œidâ€);

// bad é€šè¿‡JSæ¥è¦†å†™å¯¹è±¡çš„æ ·å¼æ˜¯æ¯”è¾ƒå…¸å‹çš„ä¸€ç§é”€æ¯åŸæ ·å¼å¹¶é‡å»ºçš„è¿‡ç¨‹ï¼Œè¿™ç§é”€æ¯å’Œé‡å»ºï¼Œéƒ½ä¼šå¢åŠ æµè§ˆå™¨çš„å¼€é”€ã€‚

el.style.left = "10px";

el.style.top = "10px";

// good

el.className += " newClassName";//or

el.style.cssText += ";left:10px;top:10px;width:20px;height:20px;"
```

2.ä¸è¦ç»å¸¸è®¿é—®ä¼šå¼•èµ·æµè§ˆå™¨flushé˜Ÿåˆ—çš„å±æ€§ï¼Œå¦‚æœä½ ç¡®å®è¦è®¿é—®ï¼Œåˆ©ç”¨**ç¼“å­˜ã€‚**

```
// bad

for (const i = 0; i < len; i++) {

  el.style.left = el.offsetLeft + x + "px";

}

// good

let x = el.offsetLeft

for (var i = 0; i < len; i++) {

  x += 10;

  el.style = x + "px";

}



// bad

div.style.left = div.offsetLeft + 10 + "px";

div.style.top = div.offsetTop + 10 + "px";

// good

const left = div.offsetLeft;

const top  = div.offsetTop;

div.style.left = left + 10 + "px";

div.style.top = top + 10 + "px";
```

3.DOMç¦»çº¿åŒ–ï¼šä½¿ç”¨`display:none`

```
// bad

function appendDataToElement(appendToElement, data) {

    let li;

    for (let i = 0; i < data.length; i++) {

        li = document.createElement('li');

        li.textContent = 'text';

        appendToElement.appendChild(li);

    }

}



const ul = document.getElementById('list');

appendDataToElement(ul, data);



// good

function appendDataToElement(appendToElement, data) {

    let li;

    for (let i = 0; i < data.length; i++) {

        li = document.createElement('li');

        li.textContent = 'text';

        appendToElement.appendChild(li);

    }

}

const ul = document.getElementById('list');

ul.style.display = 'none';

appendDataToElement(ul, data);

ul.style.display = 'block';
```

4.`position`å±æ€§ä¸º`absolute`æˆ–`fixed`çš„å…ƒç´ ï¼Œé‡æ’çš„å¼€é”€ä¼šæ¯”è¾ƒå°ï¼Œå› ä¸ºä¸ç”¨è€ƒè™‘å®ƒå¯¹å…¶ä»–å…ƒç´ çš„å½±å“ [Demo](https://chenjigeng.github.io/example/share/é¿å…å›æµé‡ç»˜/å°†å¤æ‚åŠ¨ç”»æµ®åŠ¨åŒ–.html)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MzZhNjNhN2ZmYjA4NDUzNzFmZGFlNzliNDllMGZhNmJfeVhIenNYMXpMS3Z6NEtSNTUwY2lpQVFmUFljcHpnb1JfVG9rZW46Ym94azRHR09hckJWNk9hdHRjM2VhMzI3M2pSXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MWNiYjFkMmY1YTdhOWQwZWVjNDVhMjM5MmI0OTNhMTBfUFNhcktRRkhrQ0tpRnNYYlhaQkUyQTFJeFQ3QVJXUXFfVG9rZW46Ym94azQ0azlUSnR5ZzdyZHprbjMxS1FMdE9kXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

5.åŠ¨ç”»æ•ˆæœå°½é‡ä½¿ç”¨åˆæˆ ï¼Œä½†æ˜¯ä¸è¦æ»¥ç”¨

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=M2I5ZjcxNTYzMmRiNDllNDY3YTk4Y2E0MTdjOWFiOGNfTTB1YnZlWUgzNzY3RFl2a241Q1VRUDRFQ1h1Z0dPcEpfVG9rZW46Ym94azRXM2hHMXBUU21BbHhKQnBCWnlmNWs2XzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=YWZkM2FiYzU1YmVlZmVkZWM0MmM4ZWIxZWFjZDQ3ZTVfWDdSRnV0WTBZVVZwREh4dXRaRnp5Y09aMUxmTFBzbGFfVG9rZW46Ym94azRrQmRzZjBtazBFODRaWTF2bTdLSTFjXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

æ—¶é—´å¯¹æ¯”ï¼štransformåŠ¨ç”»è€—æ—¶çº¦ç­‰äºmarginåŠ¨ç”»è€—æ—¶çš„1/4ï¼Œæ€§èƒ½ä¼˜åŒ–75%

æ— æ³•å¤åˆ¶åŠ è½½ä¸­çš„å†…å®¹

5.é€‰æ‹©ä½¿ç”¨ `window.requestAnimationFrame()`ã€`window.requestIdleCallback()`ä¼˜åŒ–åŠ¨ç”»

6.åˆ†æä¸€ä¸ªğŸŒ°  [Demo](https://googlechrome.github.io/devtools-samples/jank/)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZjRjNTM0N2VmNDVhMjgwYWRkZWJmZGZlZmZjMmU5MTFfUkVDRFN4S2dKQnpTN0taTE11UU94dXI0SG9WRndCeTdfVG9rZW46Ym94azRncXhSYjJ1dkhvZ1d2Smg2RkhKVWcxXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=ZmYxYmJmZDBmMDhmZTk5NDg3NzRiMTRlNzQ3OTZjYjZfaW9iR1MwRm5XUzFYbVp2bFZnSGRONG9seGoxSGdBMm9fVG9rZW46Ym94azQ1bHpiMkY2TFdWSEJucnhZS2E4RDJlXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=NjI2ZDI2ZGUyZGM3Mzg5OTdkZTg0YmQwZTNlYzNlOTVfYnZmdjJuOGtVWkNUUTM4WndYb3JUeWZyUGZ3aUw3SnFfVG9rZW46Ym94azRFaldHOW9iOFhOcjdIaDFtYkJwYktnXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

![img](https://xiaomi.f.mioffice.cn/space/api/box/stream/download/asynccode/?code=MWYxNDIwYzJhYWFhMWE2ZGVmYjhmNWJmZmY2NDBkODlfNGJSY0pBcDMzekpkbHVNeTR1cUdiclUwanI3NklFdXZfVG9rZW46Ym94azRQNlpPQ2ZqWFZwcGNOejI5aVdPME5jXzE2NDYyMTgxNjc6MTY0NjIyMTc2N19WNA)

```
// å¼ºåˆ¶è§¦å‘å¸ƒå±€

m.style.top = pos + 'px';

if (m.offsetTop === 0) {

  m.classList.remove('up');

  m.classList.add('down');

}
```